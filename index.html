<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>圖片轉 3 秒 MP4 工具</title>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
        .container { max-width: 600px; margin: auto; border: 1px solid #ccc; padding: 20px; border-radius: 8px; }
        #status { color: blue; margin-top: 10px; }
        video { width: 100%; margin-top: 20px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>圖片轉 3 秒 MP4</h2>
    <input type="file" id="imageInput" accept="image/*">
    <button onclick="convertToVideo()">開始轉換</button>
    
    <div id="status">準備就緒</div>
    <video id="outputVideo" controls></video>
    <br>
    <a id="downloadBtn" style="display:none">下載 MP4</a>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });

    async function convertToVideo() {
        const fileInput = document.getElementById('imageInput');
        const status = document.getElementById('status');
        const videoEl = document.getElementById('outputVideo');
        const downloadBtn = document.getElementById('downloadBtn');

        if (fileInput.files.length === 0) {
            alert('請先選擇一張圖片');
            return;
        }

        status.innerText = '正在載入核心組件...';
        if (!ffmpeg.isLoaded()) await ffmpeg.load();

        const file = fileInput.files[0];
        const fileName = 'input_image.png';
        
        status.innerText = '正在處理影片...';
        
        // 1. 將檔案寫入 FFmpeg 虛擬檔案系統
        ffmpeg.FS('writeFile', fileName, await fetchFile(file));

        // 2. 執行指令：-loop 1 (循環圖片) -t 3 (持續3秒) 
        // 使用 libx264 編碼，確保大多數播放器相容
        await ffmpeg.run(
            '-loop', '1', 
            '-i', fileName, 
            '-c:v', 'libx264', 
            '-t', '3', 
            '-pix_fmt', 'yuv420p', 
            '-vf', 'scale=trunc(iw/2)*2:trunc(ih/2)*2', // 寬高必須是2的倍數
            'output.mp4'
        );

        // 3. 讀取產出的檔案
        const data = ffmpeg.FS('readFile', 'output.mp4');

        // 4. 建立 URL 並顯示
        const videoUrl = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
        videoEl.src = videoUrl;
        videoEl.style.display = 'block';
        
        downloadBtn.href = videoUrl;
        downloadBtn.download = 'generated_video.mp4';
        downloadBtn.innerText = '下載產出的 3 秒影片';
        downloadBtn.style.display = 'block';
        
        status.innerText = '轉換完成！';
    }
</script>

</body>
</html>
