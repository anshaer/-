<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AI å°æŠ—å·¥å…· - MP4 å¼·åŒ–ç‰ˆ (FFmpeg.wasm)</title>
    <script src="coi-serviceworker.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background: #1a1a1a; color: #eee; padding: 20px; }
        .controls, .video-controls { background: #2c2c2c; padding: 20px; border-radius: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; width: 100%; max-width: 750px; border: 1px solid #444; }
        .full-width { grid-column: span 2; }
        canvas { max-width: 95vw; border: 2px solid #555; background: #000; }
        input[type="range"] { width: 100%; }
        button { padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .btn-video { background: #e74c3c; color: white; width: 100%; }
        progress { width: 100%; height: 20px; accent-color: #3498db; }
        #progressContainer { display: none; width: 100%; text-align: center; }
        #statusText { margin-top: 5px; color: #3498db; font-weight: bold; }
    </style>
</head>
<body>

    <h2>ğŸ¨ AI è¦–è¦ºå°æŠ—ï¼šMP4 ç”Ÿæˆå·¥å…·</h2>

    <div class="controls">
        <div class="full-width">
            <label>1. ä¸Šå‚³åœ–ç‰‡ï¼š</label>
            <input type="file" id="upload" accept="image/*">
        </div>
        <div class="full-width">
            <label>ç¬¦è™Ÿå¯†åº¦: <span id="val-spacing">40</span></label>
            <input type="range" id="spacing" min="15" max="100" value="40">
        </div>
        <button id="re-random" style="background:#34495e; color:white;">æ¸¬è©¦å–®å¼µæ•ˆæœ</button>
    </div>

    <canvas id="canvas"></canvas>

    <div class="video-controls">
        <div class="full-width">
            <label>å½±ç‰‡æ™‚é•·: <span id="val-duration">5</span> ç§’</label>
            <input type="range" id="duration" min="1" max="15" value="5">
        </div>
        
        <button id="startRecord" class="btn-video" disabled>ç”Ÿæˆ MP4 å½±ç‰‡ (FFmpeg)</button>
        
        <div id="progressContainer" class="full-width">
            <progress id="videoProgress" value="0" max="100"></progress>
            <p id="statusText">è¼‰å…¥ FFmpeg æ ¸å¿ƒä¸­...</p>
        </div>

        <a id="downloadLink" style="display:none;" class="full-width">
            <button style="background:#27ae60; color:white; width:100%">ğŸ’¾ ä¸‹è¼‰ MP4 å½±ç‰‡</button>
        </a>
    </div>

    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.7/dist/umd/ffmpeg.umd.js"></script>
    <script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>

    <script>
        const { FFmpeg } = window.FFmpeg;
        const { fetchFile } = window.FFmpegUtil;
        let ffmpeg = null;

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const shapes = ['â– ','â—','âœ–','â›°ï¸','âœš','âœ¦','â™¥','â™ '];
        let img = new Image();

        // ç›£è½åœ–ç‰‡ä¸Šå‚³
        document.getElementById('upload').addEventListener('change', (e) => {
            const reader = new FileReader();
            reader.onload = (f) => {
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    draw();
                    document.getElementById('startRecord').disabled = false;
                };
                img.src = f.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        });

        function draw() {
            if (!img.src) return;
            const sSpacing = parseInt(document.getElementById('spacing').value);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            ctx.globalCompositeOperation = 'destination-out';
            ctx.font = `25px sans-serif`;
            for (let y = -20; y < canvas.height + 20; y += sSpacing) {
                for (let x = -20; x < canvas.width + 20; x += sSpacing) {
                    ctx.save();
                    ctx.translate(x + (Math.random()-0.5)*15, y + (Math.random()-0.5)*15);
                    ctx.rotate(Math.random() * Math.PI * 2);
                    ctx.fillText(shapes[Math.floor(Math.random()*shapes.length)], 0, 0);
                    ctx.restore();
                }
            }
            ctx.globalCompositeOperation = 'source-over';
        }

        document.getElementById('spacing').oninput = (e) => {
            document.getElementById('val-spacing').textContent = e.target.value;
            draw();
        };

        // --- FFmpeg MP4 éŒ„è£½èˆ‡è½‰ç¢¼é‚è¼¯ ---
        const startBtn = document.getElementById('startRecord');
        const statusText = document.getElementById('statusText');
        const progressBar = document.getElementById('videoProgress');

        startBtn.onclick = async () => {
            const duration = parseInt(document.getElementById('duration').value);
            const fps = 24; 
            const totalFrames = duration * fps;
            
            startBtn.disabled = true;
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('downloadLink').style.display = 'none';

            // 1. åˆå§‹åŒ– FFmpeg
            if (!ffmpeg) {
                statusText.textContent = "æ­£åœ¨è¼‰å…¥ FFmpeg æ ¸å¿ƒ...";
                ffmpeg = new FFmpeg();
                await ffmpeg.load({
                    coreURL: 'https://unpkg.com/@ffmpeg/core@0.12.4/dist/umd/ffmpeg-core.js',
                    wasmURL: 'https://unpkg.com/@ffmpeg/core@0.12.4/dist/umd/ffmpeg-core.wasm',
                });
            }

            // 2. éŒ„è£½ Canvas å½±æ ¼ä¸¦æš«å­˜ç‚º WebM (æœ€å¿«é€Ÿçš„æ–¹å¼)
            statusText.textContent = "éŒ„è£½ç•«é¢ä¸­...";
            const chunks = [];
            const stream = canvas.captureStream(fps);
            const recorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp9' });

            recorder.ondataavailable = e => chunks.push(e.data);
            
            const recordPromise = new Promise(resolve => {
                recorder.onstop = resolve;
            });

            recorder.start();
            let frameCount = 0;
            const recordInterval = setInterval(() => {
                draw();
                frameCount++;
                progressBar.value = (frameCount / totalFrames) * 50; // éŒ„è£½ä½” 50%
                if (frameCount >= totalFrames) {
                    clearInterval(recordInterval);
                    recorder.stop();
                }
            }, 1000 / fps);

            await recordPromise;

            // 3. ä½¿ç”¨ FFmpeg è½‰ç¢¼ WebM ç‚º MP4
            statusText.textContent = "è½‰ç¢¼ç‚º MP4 ä¸­ (è«‹ç¨å€™)...";
            const webmBlob = new Blob(chunks, { type: 'video/webm' });
            const webmFile = await fetchFile(webmBlob);
            
            await ffmpeg.writeFile('input.webm', webmFile);
            
            // åŸ·è¡Œè½‰ç¢¼æŒ‡ä»¤
            // -c:v libx264 ç¢ºä¿ MP4 ç›¸å®¹æ€§æœ€é«˜
            await ffmpeg.exec(['-i', 'input.webm', '-c:v', 'libx264', '-pix_fmt', 'yuv420p', 'output.mp4']);
            
            const data = await ffmpeg.readFile('output.mp4');
            const mp4Blob = new Blob([data.buffer], { type: 'video/mp4' });
            
            // 4. ä¸‹è¼‰
            const url = URL.createObjectURL(mp4Blob);
            document.getElementById('downloadLink').href = url;
            document.getElementById('downloadLink').download = `anti_ai_${Date.now()}.mp4`;
            document.getElementById('downloadLink').style.display = 'block';
            
            progressBar.value = 100;
            statusText.textContent = "MP4 è£½ä½œæˆåŠŸï¼";
            startBtn.disabled = false;
        };

        document.getElementById('re-random').onclick = draw;
    </script>
</body>
</html>
