<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>圖片轉 GIF - 效能修正版</title>
    <script src="gifshot.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 350px; text-align: center; }
        .status { background: #d4edda; color: #155724; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; }
        button { background: #007bff; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; }
        button:disabled { background: #ccc; }
        #tip { margin: 10px 0; font-size: 13px; color: #666; }
        img { max-width: 100%; margin-top: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="card">
    <div class="status">✅ 引擎載入成功</div>
    <input type="file" id="picInput" accept="image/*">
    <p id="tip">請選取圖片後點擊轉換</p>
    <button id="runBtn">開始轉換 (已優化讀取)</button>

    <div id="result" style="display:none;">
        <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
        <div id="gifArea"></div>
        <br>
        <a id="save" download="output.gif"><button style="background:#28a745">下載 GIF 檔案</button></a>
    </div>
</div>

<script>
    document.getElementById('runBtn').onclick = async function() {
        const file = document.getElementById('picInput').files[0];
        if (!file) return;

        const btn = this;
        const tip = document.getElementById('tip');
        btn.disabled = true;
        tip.innerText = "⏳ 正在處理中 (已開啟軟體渲染)...";

        // 預處理：手動縮圖並套用 willReadFrequently
        const processedImg = await getOptimizedImage(file);

        gifshot.createGIF({
            images: [processedImg],
            gifWidth: 400,
            gifHeight: 400,
            numFrames: 1,
            sampleInterval: 20 // 兼顧速度與品質
        }, function(obj) {
            if (!obj.error) {
                document.getElementById('gifArea').innerHTML = `<img src="${obj.image}">`;
                document.getElementById('save').href = obj.image;
                document.getElementById('result').style.display = "block";
                tip.innerText = "✅ 轉換完成！";
            } else {
                tip.innerText = "❌ 錯誤：" + obj.error;
            }
            btn.disabled = false;
        });
    };

    // 關鍵函數：套用您截圖中提到的 willReadFrequently 優化
    function getOptimizedImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    // 正確套用 willReadFrequently 選項
                    const ctx = canvas.getContext('2d', { willReadFrequently: true });
                    
                    // 設定適中尺寸，避免運算過量
                    canvas.width = 400;
                    canvas.height = 400;
                    
                    // 繪製圖片
                    ctx.drawImage(img, 0, 0, 400, 400);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }
</script>

</body>
</html>
