<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AI å°æŠ—å…¨åŠŸèƒ½å·¥ä½œç«™ - MP4 å¼·åŒ–ç‰ˆ</title>
    <script src="coi-serviceworker.js"></script>
    <style>
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; display: flex; flex-direction: column; align-items: center; background: #1a1a1a; color: #eee; padding: 20px; }
        .controls, .video-controls { background: #2c2c2c; padding: 20px; border-radius: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; width: 100%; max-width: 800px; border: 1px solid #444; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .full-width { grid-column: span 2; }
        .section-title { font-weight: bold; color: #9b59b6; margin-top: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .mode-selector { background: #3d3d3d; padding: 15px; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        canvas { 
            max-width: 95vw; border: 2px solid #555;
            background-image: linear-gradient(45deg, #222 25%, transparent 25%), linear-gradient(-45deg, #222 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #222 75%), linear-gradient(-45deg, transparent 75%, #222 75%);
            background-size: 20px 20px;
        }
        input[type="range"] { width: 100%; cursor: pointer; }
        input[type="text"] { width: 100%; padding: 10px; box-sizing: border-box; background: #444; border: 1px solid #666; color: white; border-radius: 6px; }
        label { font-size: 13px; color: #ccc; display: block; margin-bottom: 5px; }
        button { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-random { background: #34495e; color: white; }
        .btn-download { background: #27ae60; color: white; }
        .btn-video { background: #e74c3c; color: white; grid-column: span 2; }
        button:disabled { background: #555 !important; opacity: 0.6; cursor: not-allowed; }
        progress { width: 100%; height: 20px; accent-color: #3498db; }
        #statusText { color: #3498db; font-weight: bold; text-align: center; width: 100%; margin-top: 5px; }
    </style>
</head>
<body>

    <h2>ğŸ¨ AI è¦–è¦ºå°æŠ—å·¥ä½œç«™ (MP4 Export)</h2>

    <div id="uiContainer" class="controls">
        <div class="full-width">
            <label>1. ä¸Šå‚³åº•åœ–ï¼š</label>
            <input type="file" id="upload" accept="image/*">
        </div>
        
        <div class="mode-selector full-width">
            <label style="width:100%">ç¬¦è™Ÿé¡è‰²æ¨¡å¼ï¼š</label>
            <input type="radio" name="mode" id="modeHole" value="hole" checked><label for="modeHole">é€æ˜æŒ–å­”</label>
            <input type="radio" name="mode" id="modeRandom" value="random"><label for="modeRandom">éš¨æ©Ÿé¡è‰²</label>
            <input type="radio" name="mode" id="modeFixed" value="fixed"><label for="modeFixed">æŒ‡å®šé¡è‰²</label>
            <input type="color" id="fixedColorPicker" value="#ffffff">
        </div>

        <div>
            <label>ç¬¦è™Ÿå¤§å°: <span id="val-radius">25</span></label>
            <input type="range" id="radius" min="10" max="100" value="25">
        </div>
        <div>
            <label>åˆ†å¸ƒå¯†åº¦: <span id="val-spacing">40</span></label>
            <input type="range" id="spacing" min="15" max="150" value="40">
        </div>

        <div class="full-width section-title">æ–‡å­—é˜²è­·å±¤</div>
        <input type="text" id="overlayText" class="full-width" placeholder="åœ¨æ­¤è¼¸å…¥æ–‡å­—...">
        
        <div>
            <label>æ–‡å­—å¤§å°: <span id="val-fontSize">80</span></label>
            <input type="range" id="fontSize" min="20" max="400" value="80">
        </div>
        <div>
            <label>æ–‡å­—é¡è‰²ï¼š</label>
            <input type="color" id="textColor" value="#ffffff" style="width:100%">
        </div>
        
        <button id="re-random" class="btn-random">éš¨æ©Ÿæ‰“äº‚ä½ç½®</button>
        <button id="downloadPNG" class="btn-download">ä¸‹è¼‰ PNG åœ–ç‰‡</button>
    </div>

    <canvas id="canvas"></canvas>

    <div class="video-controls">
        <div class="full-width section-title">ğŸ¬ å½±ç‰‡ç”Ÿæˆ (MP4 æ ¼å¼)</div>
        <div class="full-width">
            <label>å½±ç‰‡æ™‚é•·: <span id="val-duration">5</span> ç§’</label>
            <input type="range" id="duration" min="1" max="15" value="5">
        </div>
        
        <button id="startRecord" class="btn-video" disabled>ç”Ÿæˆ MP4 å½±ç‰‡</button>
        
        <div id="progressContainer" class="full-width" style="display:none;">
            <progress id="videoProgress" value="0" max="100"></progress>
            <p id="statusText">æ­£åœ¨è¼‰å…¥ FFmpeg...</p>
        </div>

        <a id="downloadLink" style="display:none;" class="full-width">
            <button class="btn-download" style="width:100%">ğŸ’¾ ä¸‹è¼‰ç”¢å‡ºçš„ MP4</button>
        </a>
    </div>

    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.7/dist/umd/ffmpeg.umd.js"></script>
    <script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>

    <script>
        const { FFmpeg } = window.FFmpeg;
        const { fetchFile } = window.FFmpegUtil;
        let ffmpeg = null;

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const upload = document.getElementById('upload');
        const shapes = ['â– ','â—','âœ–','â›°ï¸','âœš','âœ¦','â™¥','â™ ','â‹','âˆ','âš¡ï¸','âœ¨'];
        let img = new Image();

        // æ§åˆ¶é …è¯é›†
        const inputs = document.querySelectorAll('input, button');

        upload.addEventListener('change', (e) => {
            const reader = new FileReader();
            reader.onload = (f) => {
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    draw();
                    document.getElementById('startRecord').disabled = false;
                };
                img.src = f.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        });

        function draw() {
            if (!img.src) return;
            const sRadius = parseInt(document.getElementById('radius').value);
            const sSpacing = parseInt(document.getElementById('spacing').value);
            const fSize = parseInt(document.getElementById('fontSize').value);
            const txt = document.getElementById('overlayText').value;
            let mode = 'hole';
            document.getElementsByName('mode').forEach(r => { if(r.checked) mode = r.value; });

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);

            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = `${sRadius}px sans-serif`;

            if (mode === 'hole') ctx.globalCompositeOperation = 'destination-out';
            else ctx.globalCompositeOperation = 'source-over';

            for (let y = -sSpacing; y < canvas.height + sSpacing; y += sSpacing) {
                for (let x = -sSpacing; x < canvas.width + sSpacing; x += sSpacing) {
                    ctx.save();
                    const jitter = sSpacing * 0.4;
                    ctx.translate(x + (Math.random()-0.5)*jitter, y + (Math.random()-0.5)*jitter);
                    ctx.rotate(Math.random() * Math.PI * 2);
                    if (mode === 'random') ctx.fillStyle = `rgb(${Math.random()*255},${Math.random()*255},${Math.random()*255})`;
                    else ctx.fillStyle = document.getElementById('fixedColorPicker').value;
                    ctx.fillText(shapes[Math.floor(Math.random()*shapes.length)], 0, 0);
                    ctx.restore();
                }
            }

            ctx.globalCompositeOperation = 'source-over';
            if (txt) {
                ctx.font = `bold ${fSize}px sans-serif`;
                ctx.strokeStyle = 'rgba(0,0,0,0.7)';
                ctx.lineWidth = fSize / 8;
                ctx.strokeText(txt, canvas.width/2, canvas.height/2);
                ctx.fillStyle = document.getElementById('textColor').value;
                ctx.fillText(txt, canvas.width/2, canvas.height/2);
            }
        }

        // æ»‘æ¡¿äº‹ä»¶
        document.querySelectorAll('input[type="range"]').forEach(input => {
            input.addEventListener('input', () => {
                document.getElementById(`val-${input.id}`).textContent = input.value;
                draw();
            });
        });

        // MP4 éŒ„è£½èˆ‡è½‰ç¢¼
        const startBtn = document.getElementById('startRecord');
        const statusText = document.getElementById('statusText');
        const progressBar = document.getElementById('videoProgress');

        startBtn.onclick = async () => {
            const duration = parseInt(document.getElementById('duration').value);
            const fps = 24;
            const totalFrames = duration * fps;
            
            inputs.forEach(i => i.disabled = true);
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('downloadLink').style.display = 'none';

            if (!ffmpeg) {
                statusText.textContent = "è¼‰å…¥ FFmpeg æ ¸å¿ƒ...";
                ffmpeg = new FFmpeg();
                await ffmpeg.load({
                    coreURL: 'https://unpkg.com/@ffmpeg/core@0.12.4/dist/umd/ffmpeg-core.js',
                    wasmURL: 'https://unpkg.com/@ffmpeg/core@0.12.4/dist/umd/ffmpeg-core.wasm',
                });
            }

            statusText.textContent = "æ­£åœ¨éŒ„è£½æ¯ä¸€å½±æ ¼...";
            const chunks = [];
            const stream = canvas.captureStream(fps);
            const recorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp9' });
            recorder.ondataavailable = e => chunks.push(e.data);
            
            const recordPromise = new Promise(res => recorder.onstop = res);
            recorder.start();

            let frames = 0;
            const timer = setInterval(() => {
                draw(); // æ¯ä¸€å¹€éƒ½é‡æ–°æŠ–å‹•ï¼Œå¢åŠ  AI é›£åº¦
                frames++;
                progressBar.value = (frames / totalFrames) * 40; // éŒ„è£½ä½” 40%
                statusText.textContent = `éŒ„è£½ä¸­: ${Math.floor((frames/totalFrames)*100)}%`;
                if (frames >= totalFrames) {
                    clearInterval(timer);
                    recorder.stop();
                }
            }, 1000 / fps);

            await recordPromise;

            statusText.textContent = "æ­£åœ¨å°è£æˆ MP4 (H.264)...";
            const webmBlob = new Blob(chunks, { type: 'video/webm' });
            await ffmpeg.writeFile('input.webm', await fetchFile(webmBlob));
            
            // è½‰ç¢¼
            await ffmpeg.exec(['-i', 'input.webm', '-c:v', 'libx264', '-pix_fmt', 'yuv420p', 'output.mp4']);
            
            const data = await ffmpeg.readFile('output.mp4');
            const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
            
            const link = document.getElementById('downloadLink');
            link.href = url;
            link.download = `protected_video_${Date.now()}.mp4`;
            link.style.display = 'block';
            
            progressBar.value = 100;
            statusText.textContent = "å®Œæˆï¼å¯ä¸‹è¼‰å½±ç‰‡";
            inputs.forEach(i => i.disabled = false);
        };

        document.getElementById('re-random').onclick = draw;
        document.getElementById('downloadPNG').onclick = () => {
            const a = document.createElement('a');
            a.download = 'protected_image.png';
            a.href = canvas.toDataURL();
            a.click();
        };
    </script>
</body>
</html>
