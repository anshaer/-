<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>圖片轉影片</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        :root {
            --primary-color: #007AFF; 
            --text-main: #1c1c1e;
            --text-sub: #8e8e93;
            --input-bg: #ffffff;
        }
        
        /* 移除卡片感，改為純色背景直接鋪滿 */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #ffffff; /* 或者使用 #f9f9f9 */
            margin: 0; 
            padding: 20px;
            color: var(--text-main);
            display: flex;
            justify-content: center;
        }

        .container { 
            width: 100%; 
            max-width: 500px; 
            padding-top: 10px;
        }

        h2 { font-size: 24px; margin-bottom: 8px; text-align: left; font-weight: 700; }
        .subtitle { color: var(--text-sub); font-size: 14px; text-align: left; margin-bottom: 30px; }
        
        .input-group { margin-bottom: 24px; }
        label { display: block; font-weight: 600; margin-bottom: 10px; font-size: 15px; }
        
        /* 讓輸入框更有質感 */
        input[type="file"], select {
            width: 100%;
            padding: 14px;
            border: 1px solid #e5e5ea;
            border-radius: 12px;
            box-sizing: border-box;
            font-size: 16px;
            background-color: #f2f2f7; /* 淺灰色背景 */
            appearance: none; /* 移除預設樣式 */
        }

        button { 
            background: var(--primary-color); 
            color: white; 
            border: none; 
            width: 100%;
            padding: 16px; 
            border-radius: 14px; 
            font-size: 17px; 
            font-weight: 600;
            cursor: pointer; 
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(0,122,255,0.2);
        }
        button:disabled { background: #d1d1d6; box-shadow: none; }

        #status { 
            margin-top: 20px; 
            font-size: 14px; 
            color: var(--text-sub); 
            text-align: center;
        }

        .preview-box { 
            margin-top: 30px; 
            padding-top: 20px; 
            border-top: 1px solid #eee;
            display: none; 
        }
        
        video { 
            width: 100%; 
            border-radius: 12px; 
            background: #000;
        }

        .download-btn {
            display: block;
            text-align: center;
            margin-top: 20px;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            padding: 10px;
            font-size: 16px;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>圖片轉影片</h2>
    <p class="subtitle">將您的圖片轉換為 3 秒 MP4 影片</p>

    <div class="input-group">
        <label>選擇來源圖片</label>
        <input type="file" id="uploader" accept="image/*">
    </div>

    <div class="input-group">
        <label>輸出畫質設定</label>
        <select id="qualitySelect">
            <option value="480">480p (速度最快)</option>
            <option value="720" selected>720p (標準高清)</option>
            <option value="1080">1080p (全高清)</option>
        </select>
    </div>

    <button id="convertBtn">開始轉換影片</button>
    <p id="status">準備就緒</p>

    <div class="preview-box" id="previewBox">
        <video id="videoPreview" controls></video>
        <a id="downloadLink" class="download-btn">⬇️ 下載轉換後的影片</a>
    </div>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ 
        log: true,
        corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js'
    });

    const convertBtn = document.getElementById('convertBtn');
    const uploader = document.getElementById('uploader');
    const status = document.getElementById('status');
    const qualitySelect = document.getElementById('qualitySelect');

    convertBtn.onclick = async () => {
        if (uploader.files.length === 0) return alert('請選擇圖片');
        
        const file = uploader.files[0];
        const targetHeight = qualitySelect.value;
        
        convertBtn.disabled = true;
        status.innerText = '正在初始化處理引擎...';

        try {
            if (!ffmpeg.isLoaded()) await ffmpeg.load();
            
            status.innerText = '正在處理檔案...';
            const { name } = file;
            ffmpeg.FS('writeFile', name, await fetchFile(file));

            status.innerText = `製作中 (${targetHeight}p)... 請稍候`;
            
            await ffmpeg.run(
                '-loop', '1', 
                '-i', name, 
                '-c:v', 'libx264', 
                '-t', '3', 
                '-vf', `scale=-2:${targetHeight}`, 
                '-pix_fmt', 'yuv420p', 
                'output.mp4'
            );

            const data = ffmpeg.FS('readFile', 'output.mp4');
            const videoUrl = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
            
            document.getElementById('previewBox').style.display = 'block';
            document.getElementById('videoPreview').src = videoUrl;
            document.getElementById('downloadLink').href = videoUrl;
            document.getElementById('downloadLink').download = `video_${targetHeight}p.mp4`;
            
            status.innerText = '✅ 轉換完成';
            document.getElementById('previewBox').scrollIntoView({ behavior: 'smooth' });

        } catch (e) {
            console.error(e);
            status.innerText = '❌ 發生錯誤，請重試。';
        } finally {
            convertBtn.disabled = false;
        }
    };
</script>
</body>
</html>
